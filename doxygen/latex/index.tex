\chapter{STM32-\/\+Time-\/of-\/\+Flight-\/\+VL53\+L0\+X-\/\+Zephyr-\/\+RTOS}
\hypertarget{index}{}\label{index}\index{STM32-\/Time-\/of-\/Flight-\/VL53L0X-\/Zephyr-\/RTOS@{STM32-\/Time-\/of-\/Flight-\/VL53L0X-\/Zephyr-\/RTOS}}
Code documentation.


\begin{DoxyItemize}
\item Read\+Me
\end{DoxyItemize}

VL53\+L0X\+: Time Of Flight sensor \doxysubparagraph*{}

Overview \DoxyHorRuler{0}
 This sample periodically measures distance between vl53l0x sensor and target. The result is displayed on the console. It also shows how we can use the vl53l0x as a proximity sensor.

Requirements \DoxyHorRuler{0}


This sample uses the VL53\+L0X sensor controlled using the I2C interface.

References \DoxyHorRuler{0}



\begin{DoxyItemize}
\item VL53\+L0X\+: \href{http://www.st.com/en/imaging-and-photonics-solutions/vl53l0x.html}{\texttt{ http\+://www.\+st.\+com/en/imaging-\/and-\/photonics-\/solutions/vl53l0x.\+html}}
\end{DoxyItemize}

Building and Running \DoxyHorRuler{0}


This project outputs sensor data to the console. It requires a VL53\+L0X sensor, which is present on the disco\+\_\+l475\+\_\+iot1 board.

.. zephyr-\/app-\/commands\+:: \+:app\+: samples/sensor/vl53l0x/ \+:goals\+: build flash\hypertarget{index_autotoc_md0}{}\doxysection{\texorpdfstring{Sample Output}{Sample Output}}\label{index_autotoc_md0}
.. code-\/block\+:: console

prox is 0 distance is 1938 prox is 1 distance is 70 prox is 0 distance is 1995

$<$repeats endlessly every second$>$

\doxysubparagraph*{}

Golioth Light DB stream sample \doxysubparagraph*{}

Overview \DoxyHorRuler{0}


This Light DB stream application demonstrates how to connect with Golioth and periodically send data to Light DB stream. In this sample temperature measurements are sent to {\ttfamily /temp} Light DB stream path. For platforms that do not have temperature sensor a value is generated from 20 up to 30.

Requirements \DoxyHorRuler{0}



\begin{DoxyItemize}
\item Golioth credentials
\item Network connectivity
\end{DoxyItemize}

Building and Running \DoxyHorRuler{0}


Configure the following Kconfig options based on your Golioth credentials\+:


\begin{DoxyItemize}
\item GOLIOTH\+\_\+\+SYSTEM\+\_\+\+CLIENT\+\_\+\+PSK\+\_\+\+ID -\/ PSK ID of registered device
\item GOLIOTH\+\_\+\+SYSTEM\+\_\+\+CLIENT\+\_\+\+PSK -\/ PSK of registered device
\end{DoxyItemize}

by adding these lines to configuration file (e.\+g. {\ttfamily prj.\+conf})\+:

.. code-\/block\+:: cfg

CONFIG\+\_\+\+GOLIOTH\+\_\+\+SYSTEM\+\_\+\+CLIENT\+\_\+\+PSK\+\_\+\+ID="{}my-\/psk-\/id"{} CONFIG\+\_\+\+GOLIOTH\+\_\+\+SYSTEM\+\_\+\+CLIENT\+\_\+\+PSK="{}my-\/psk"{}\hypertarget{index_autotoc_md1}{}\doxysection{\texorpdfstring{Platform specific configuration}{Platform specific configuration}}\label{index_autotoc_md1}
\hypertarget{index_autotoc_md2}{}\doxysubsection{\texorpdfstring{QEMU}{QEMU}}\label{index_autotoc_md2}
This application has been built and tested with QEMU x86 (qemu\+\_\+x86).

On your Linux host computer, open a terminal window, locate the source code of this sample application (i.\+e., {\ttfamily samples/lightdb\+\_\+stream}) and type\+:

.. code-\/block\+:: console

\$ west build -\/b qemu\+\_\+x86 samples/lightdb\+\_\+stream \$ west build -\/t run

See {\ttfamily Networking with QEMU}\+\_\+ on how to setup networking on host and configure NAT/masquerading to access Internet.\hypertarget{index_autotoc_md3}{}\doxysubsection{\texorpdfstring{ESP32}{ESP32}}\label{index_autotoc_md3}
Configure the following Kconfig options based on your Wi\+Fi AP credentials\+:


\begin{DoxyItemize}
\item GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+SSID -\/ Wi\+Fi SSID
\item GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+PSK -\/ Wi\+Fi PSK
\end{DoxyItemize}

by adding these lines to configuration file (e.\+g. {\ttfamily prj.\+conf} or {\ttfamily board/esp32.\+conf})\+:

.. code-\/block\+:: cfg

CONFIG\+\_\+\+GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+SSID="{}my-\/wifi"{} CONFIG\+\_\+\+GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+PSK="{}my-\/psk"{}

On your host computer open a terminal window, locate the source code of this sample application (i.\+e., {\ttfamily samples/lightdb\+\_\+stream}) and type\+:

.. code-\/block\+:: console

\$ west build -\/b esp32 samples/lightdb\+\_\+stream \$ west flash

See {\ttfamily ESP32}\+\_\+ for details on how to use ESP32 board.\hypertarget{index_autotoc_md4}{}\doxysubsection{\texorpdfstring{n\+RF52840 DK + ESP32-\/\+WROOM-\/32}{n\+RF52840 DK + ESP32-\/\+WROOM-\/32}}\label{index_autotoc_md4}
This subsection documents using n\+RF52840 DK running Zephyr with offloaded ESP-\/\+AT Wi\+Fi driver and ESP32-\/\+WROOM-\/32 module based board (such as ESP32 DevkitC rev. 4) running Wi\+Fi stack. See {\ttfamily AT Binary Lists}\+\_\+ for links to ESP-\/\+AT binaries and details on how to flash ESP-\/\+AT image on ESP chip. Flash ESP chip with following command\+:

.. code-\/block\+:: console

esptool.\+py write\+\_\+flash --verify 0x0 PATH\+\_\+\+TO\+\_\+\+ESP\+\_\+\+AT/factory/factory\+\_\+\+WROOM-\/32.\+bin

Connect n\+RF52840 DK and ESP32-\/\+Dev\+KitC V4 (or other ESP32-\/\+WROOM-\/32 based board) using wires\+:

+-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+ \texorpdfstring{$\vert$}{|}n\+RF52840 DK\texorpdfstring{$\vert$}{|}\+ESP32-\/\+WROOM-\/32\texorpdfstring{$\vert$}{|} \texorpdfstring{$\vert$}{|} \texorpdfstring{$\vert$}{|} \texorpdfstring{$\vert$}{|} +-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+ \texorpdfstring{$\vert$}{|}\+P1.01 (RX) \texorpdfstring{$\vert$}{|}\+IO17 (TX) \texorpdfstring{$\vert$}{|} +-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+ \texorpdfstring{$\vert$}{|}\+P1.02 (TX) \texorpdfstring{$\vert$}{|}\+IO16 (RX) \texorpdfstring{$\vert$}{|} +-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+ \texorpdfstring{$\vert$}{|}\+P1.03 (CTS)\texorpdfstring{$\vert$}{|}\+IO14 (RTS) \texorpdfstring{$\vert$}{|} +-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+ \texorpdfstring{$\vert$}{|}\+P1.04 (RTS)\texorpdfstring{$\vert$}{|}\+IO15 (CTS) \texorpdfstring{$\vert$}{|} +-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+ \texorpdfstring{$\vert$}{|}\+P1.05 \texorpdfstring{$\vert$}{|}\+EN \texorpdfstring{$\vert$}{|} +-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+ \texorpdfstring{$\vert$}{|}\+GND \texorpdfstring{$\vert$}{|}\+GND \texorpdfstring{$\vert$}{|} +-\/-\/-\/-\/-\/-\/-\/-\/---+-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/---+

Configure the following Kconfig options based on your Wi\+Fi AP credentials\+:


\begin{DoxyItemize}
\item GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+SSID -\/ Wi\+Fi SSID
\item GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+PSK -\/ Wi\+Fi PSK
\end{DoxyItemize}

by adding these lines to configuration file (e.\+g. {\ttfamily prj.\+conf} or {\ttfamily board/nrf52840dk\+\_\+nrf52840.\+conf})\+:

.. code-\/block\+:: cfg

CONFIG\+\_\+\+GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+SSID="{}my-\/wifi"{} CONFIG\+\_\+\+GOLIOTH\+\_\+\+SAMPLE\+\_\+\+WIFI\+\_\+\+PSK="{}my-\/psk"{}

On your host computer open a terminal window, locate the source code of this sample application (i.\+e., {\ttfamily samples/lightdb\+\_\+stream}) and type\+:

.. code-\/block\+:: console

\$ west build -\/b nrf52840dk\+\_\+nrf52840 samples/lightdb\+\_\+stream \$ west flash\hypertarget{index_autotoc_md5}{}\doxysubsection{\texorpdfstring{n\+RF9160 DK}{n\+RF9160 DK}}\label{index_autotoc_md5}
On your host computer open a terminal window, locate the source code of this sample application (i.\+e., {\ttfamily samples/ligthdb\+\_\+stream}) and type\+:

.. code-\/block\+:: console

\$ west build -\/b nrf9160dk\+\_\+nrf9160\+\_\+ns samples/lightdb\+\_\+stream \$ west flash\hypertarget{index_autotoc_md6}{}\doxysection{\texorpdfstring{Sample output}{Sample output}}\label{index_autotoc_md6}
This is the output from the serial console\+:

.. code-\/block\+:: console

\mbox{[}00\+:00\+:00.\+000,000\mbox{]} $<$inf$>$ golioth\+\_\+system\+: Initializing \mbox{[}00\+:00\+:00.\+000,000\mbox{]} $<$inf$>$ net\+\_\+config\+: Initializing network \mbox{[}00\+:00\+:00.\+000,000\mbox{]} $<$inf$>$ net\+\_\+config\+: IPv4 address\+: 192.\+0.\+2.\+1 \mbox{[}00\+:00\+:00.\+000,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Start Light DB stream sample \mbox{[}00\+:00\+:00.\+000,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 20.\+000000 \mbox{[}00\+:00\+:00.\+000,000\mbox{]} $<$inf$>$ golioth\+\_\+system\+: Starting connect \mbox{[}00\+:00\+:00.\+010,000\mbox{]} $<$inf$>$ golioth\+\_\+system\+: Client connected! \mbox{[}00\+:00\+:05.\+010,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 20.\+500000 \mbox{[}00\+:00\+:10.\+040,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 21.\+000000 \mbox{[}00\+:00\+:15.\+050,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 21.\+500000 \mbox{[}00\+:00\+:20.\+060,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 22.\+000000 \mbox{[}00\+:00\+:25.\+070,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 22.\+500000 \mbox{[}00\+:00\+:30.\+080,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 23.\+000000 \mbox{[}00\+:00\+:35.\+090,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 23.\+500000 \mbox{[}00\+:00\+:40.\+100,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 24.\+000000 \mbox{[}00\+:00\+:45.\+110,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 24.\+500000 \mbox{[}00\+:00\+:50.\+120,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 25.\+000000 \mbox{[}00\+:00\+:55.\+130,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 25.\+500000 \mbox{[}00\+:01\+:00.\+140,000\mbox{]} $<$dbg$>$ golioth\+\_\+lightdb\+\_\+stream.\+main\+: Sending temperature 26.\+000000\hypertarget{index_autotoc_md7}{}\doxysection{\texorpdfstring{Monitor temperature value over time}{Monitor temperature value over time}}\label{index_autotoc_md7}
Device sends temperature measurements every 5s and updates {\ttfamily /temp} resource in Light DB stream. Current value can be fetched using following command\+:

.. code-\/block\+:: console

\$ goliothctl stream get \texorpdfstring{$<$}{<}device-\/id\texorpdfstring{$>$}{>} /temp 26

Historical data can be queried using following command\+:

.. code-\/block\+:: console

\$ goliothctl stream query --interval 5m --field time --field temp \texorpdfstring{$\vert$}{|} jq \textquotesingle{}\textquotesingle{} \mbox{[} \{ "{}temp"{}\+: 26, "{}time"{}\+: "{}2021-\/06-\/08 12\+:17\+:01.\+158 +0000 UTC"{} \}, \{ "{}temp"{}\+: 25.\+5, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:56.\+146 +0000 UTC"{} \}, \{ "{}temp"{}\+: 25, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:51.\+138 +0000 UTC"{} \}, \{ "{}temp"{}\+: 24.\+5, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:46.\+126 +0000 UTC"{} \}, \{ "{}temp"{}\+: 24, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:41.\+114 +0000 UTC"{} \}, \{ "{}temp"{}\+: 23.\+5, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:36.\+108 +0000 UTC"{} \}, \{ "{}temp"{}\+: 23, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:31.\+098 +0000 UTC"{} \}, \{ "{}temp"{}\+: 22.\+5, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:26.\+088 +0000 UTC"{} \}, \{ "{}temp"{}\+: 22, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:21.\+078 +0000 UTC"{} \}, \{ "{}temp"{}\+: 21.\+5, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:16.\+068 +0000 UTC"{} \}, \{ "{}temp"{}\+: 21, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:11.\+054 +0000 UTC"{} \}, \{ "{}temp"{}\+: 20.\+5, "{}time"{}\+: "{}2021-\/06-\/08 12\+:16\+:06.\+049 +0000 UTC"{} \} \mbox{]}

.. \+\_\+\+Networking with QEMU\+: \href{https://docs.zephyrproject.org/3.0.0/guides/networking/qemu_setup.html\#networking-with-qemu}{\texttt{ https\+://docs.\+zephyrproject.\+org/3.\+0.\+0/guides/networking/qemu\+\_\+setup.\+html\#networking-\/with-\/qemu}} .. \+\_\+\+ESP32\+: \href{https://docs.zephyrproject.org/3.0.0/boards/xtensa/esp32/doc/index.html}{\texttt{ https\+://docs.\+zephyrproject.\+org/3.\+0.\+0/boards/xtensa/esp32/doc/index.\+html}} .. \+\_\+\+AT Binary Lists\+: \href{https://docs.espressif.com/projects/esp-at/en/latest/AT_Binary_Lists/index.html}{\texttt{ https\+://docs.\+espressif.\+com/projects/esp-\/at/en/latest/\+AT\+\_\+\+Binary\+\_\+\+Lists/index.\+html}} 